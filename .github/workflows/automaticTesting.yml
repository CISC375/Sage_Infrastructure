name: Run Jest Tests

on:
  workflow_call:
#   push:
#     branches:
#       -  mizuho-githubaction  # Run on push to `mizuho-githubaction` branch
#       - 'feature/*'  # Or you can specify any feature branches you want to test
#   pull_request:
#     branches:
#       - mizuho-githubaction  # Run on pull request targeting `mizuho-githubaction` branch

jobs:
<<<<<<< HEAD
  jest_test:
=======
  unit_tests:
>>>>>>> origin/mizuho-integration
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
<<<<<<< HEAD
          node-version: ">=18"
          cache: "npm"
=======
          node-version: '20'
          cache: 'npm'
>>>>>>> origin/mizuho-integration

      - name: Install required system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libjpeg-dev libpango1.0-dev libgif-dev build-essential g++

      - name: Clean npm cache and install deps
        run: |
          npm cache clean --force
          npm ci
<<<<<<< HEAD
=======

      - name: Set config file
        run: cp config.example.ts config.ts

      - name: Show Jest config
        run: npx jest --showConfig | sed -n '1,120p'

      - name: Run Unit Tests
        run: npx jest -c jest.config.js --no-cache --testPathIgnorePatterns=".*integration.*"

  integration_tests:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: unit_tests

    services:
      mongodb:
        image: mongo:5.0
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
        ports:
          - 27017:27017
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install required system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libjpeg-dev libpango1.0-dev libgif-dev build-essential g++

      - name: Clean npm cache and install deps
        run: |
          npm cache clean --force
          npm ci

      - name: Set config file
        run: cp config.example.ts config.ts

      - name: Run Integration Tests
        run: npx jest -c jest.config.js --no-cache --testMatch="**/*integration*.test.ts"
        env:
          MONGODB_URI: mongodb://test:test@localhost:27017/sage_test?authSource=admin
>>>>>>> origin/mizuho-integration

      - name: Set config file
        run: cp config.example.ts config.ts

      - name: Show Jest config
        run: npx jest --showConfig | sed -n '1,120p'

      - name: Run Jest tests (no cache)
        run: npx jest -c jest.config.js --no-cache
