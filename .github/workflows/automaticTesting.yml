name: Run Jest Tests

on:
  push:
    branches:
      -  mizuho #main  # Run on push to `main` branch
      - 'feature/*'  # Or you can specify any feature branches you want to test
  pull_request:
    branches:
      - mizuho  # Run on pull request targeting `main` branch

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '>=18'
          cache: 'npm'

      - name: Install required system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libjpeg-dev libpango1.0-dev libgif-dev build-essential g++

      - name: Clean npm cache and install deps
        run: |
          npm cache clean --force
          npm ci

      - name: Set config file
        run: cp config.example.ts config.ts

      - name: Show Jest config
        run: npx jest --showConfig | sed -n '1,120p'

      - name: Run Jest tests (no cache)
        run: npx jest -c jest.config.js --no-cache

